---
import { Icon } from "astro-icon/components";
import { getCollection, render } from "astro:content";

// 1. Obtenemos la colecciÃ³n de proyectos
const projects = await getCollection("projects");

// 2. Diccionario de iconos y colores por estado
const stateMap = {
  "En proceso": {
    icon: "warning",
    color: "theme-yellow",
  },
  "Terminado": {
    icon: "okay",
    color: "theme-green",
  },
};

// 3. Renderizamos todos los contenidos markdown y los combinamos
const projectsWithContent = await Promise.all(
  projects.map(async (project) => {
    const { Content } = await render(project);
    return { ...project, Content };
  })
);
---

<section>
  {
    projectsWithContent.map((project) => {
      const { data, Content } = project;
      const { name, date, state } = data;

      const { icon, color } = stateMap[state] ?? {
        icon: "help",
        color: "white-400",
      };

      return (
        <div
          x-data="{ open: false }"
          x-ref="card"
          class="relative container mx-auto px-15 pb-15 transition-all duration-500 ease-in-out"
        >
          <div class="flex items-center bg-primary-medium h-30 rounded-2xl ring-6 ring-primary-light shadow-[0px_0px_24px_10px_#008ef0] px-6">
            <p class="font-bold text-white text-2xl ml-20">{name}</p>

            <div class="flex items-center justify-end w-full mr-15">
              <Icon class={`mx-4 size-10 h-20 ml-55 text-${color}`} name={icon} />
              <p class={`font-bold text-${color} text-2xl`}>{state}</p>

              <span class="flex items-center ml-15">
                <Icon
                  class="text-primary-light size-10 mr-5 hover:cursor-pointer hover:text-primary-lighter"
                  name="window_open"
                  @click="open = !open; if (open) { $nextTick(() => { $refs.card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }); }"
                />
                <Icon
                  class="text-primary-light size-10 hover:cursor-pointer hover:text-primary-lighter"
                  name="close"
                />
              </span>
            </div>
          </div>

          <div
            x-show="open"
            x-transition:enter="transition-all duration-500 ease-out"
            x-transition:enter-start="opacity-0 max-h-0"
            x-transition:enter-end="opacity-100 max-h-[500px]"
            x-transition:leave="transition-all duration-300 ease-in"
            x-transition:leave-start="opacity-100 max-h-[500px]"
            x-transition:leave-end="opacity-0 max-h-0"
            class="overflow-hidden bg-primary-medium rounded-b-2xl ring-6 ring-primary-light shadow-[0px_0px_24px_10px_#008ef0] px-6 mt-4 py-4"
          >
            <div class="text-white prose prose-invert max-w-none">
              <Content />
            </div>
          </div>
        </div>
      );
    })
  }
</section>
