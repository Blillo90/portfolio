---
import { Icon } from "astro-icon/components";
import { getCollection, render } from "astro:content";
import '/src/styles/blink.css'


const projects = await getCollection("projects");

const stateMap = {
  "En proceso": {
    icon: "warning",
    color: "theme-yellow",
  },
  "Terminado": {
    icon: "okay",
    color: "theme-green",
  },
};

const estadoOrden = {
  "En proceso": 0,
  "Terminado": 1,
};

projects.sort((a, b) => {
  return (estadoOrden[a.data.state] ?? 99) - (estadoOrden[b.data.state] ?? 99);
});

const projectsWithContent = await Promise.all(
  projects.map(async (project) => {
    const { Content } = await render(project);
    return { ...project, Content };
  })
);

---

<section>
  
  {
    projectsWithContent.map((project) => {
      const { data, Content } = project;
      const { name, date, state, img, prog_logos = [], url = [] } = data;

      const { icon, color } = stateMap[state] ?? {
        icon: "help",
        color: "white-400",
      };

      return (
        <div
          x-data="{ open: false }"
          x-ref="card"
          class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-15 ease-in-out"
        >
          

          <div class="flex flex-wrap items-center justify-between bg-primary-medium py-5 md:py-0 h-30 rounded-2xl ring-6 ring-primary-light shadow-[0px_0px_24px_10px_#008ef0] px-4 sm:px-6 py-4 gap-4">

            <p class="font-bold text-white text-lg sm:text-2xl">{name}</p>
            <div class="flex items-center gap-4 ml-auto">
              <Icon class={`size-8 md:size-10 text-${color}`} name={icon} />
              <p class={`font-bold text-${color} mr-20 text-lg sm:text-2xl`}>{state}</p>

              {/* Botones de abrir/cerrar */}
              <span class="relative w-10 h-10">
                {/* ABRIR */}
                <Icon
                  x-show="!open"
                  x-transition:enter="transition-opacity duration-200"
                  x-transition:enter-start="opacity-0"
                  x-transition:enter-end="opacity-100"
                  x-transition:leave="transition-opacity duration-150"
                  x-transition:leave-start="opacity-100"
                  x-transition:leave-end="opacity-0"
                  class="absolute top-0 left-0 w-full h-full text-primary-light hover:cursor-pointer hover:text-primary-lighter"
                  name="window_open"
                  @click= "open = true; $nextTick(() => { const top = $refs.card.getBoundingClientRect().top + window.scrollY - 80; window.scrollTo({ top, behavior: 'smooth' }); [$refs.lampLeft, $refs.lampRight].forEach(lamp => { lamp.classList.remove('animate-blink'); void lamp.offsetWidth; lamp.classList.add('animate-blink'); }); });"

                />
                {/* CERRAR */}
                <Icon
                  x-show="open"
                  x-transition:enter="transition-opacity duration-200"
                  x-transition:enter-start="opacity-0"
                  x-transition:enter-end="opacity-100"
                  x-transition:leave="transition-opacity duration-150"
                  x-transition:leave-start="opacity-100"
                  x-transition:leave-end="opacity-0"
                  class="absolute top-0 left-0 w-full h-full text-primary-light hover:cursor-pointer hover:text-red-400"
                  name="close"
                  @click= "open = false"
                />
              </span>
            </div>
          </div>

          <div
            x-show="open"
            x-transition:enter="transition-all duration-500 ease-out"
            x-transition:enter-start="opacity-0 max-h-0"
            x-transition:enter-end="opacity-100 max-h-[500px]"
            x-transition:leave="transition-all duration-300 ease-in"
            x-transition:leave-start="opacity-100 max-h-[500px]"
            x-transition:leave-end="opacity-0 max-h-0"
            class="overflow-hidden bg-primary-medium rounded-b-2xl ring-6 ring-primary-light shadow-[0px_0px_24px_10px_#008ef0] px-4 sm:px-6 py-8"
          >
            {/* LÁMPARAS DE NEÓN */}
            <div
            x-ref="lampLeft"
            class="absolute -top-0 left-1/4 mt-35 w-20 md:w-35 h-3 rounded-full z-10 transition-all duration-700"
            :class= "open ? 'bg-blue-100 shadow-[0_0_6px_#ccfaff,0_0_12px_#ccfaff] animate-blink' : 'bg-gray-600 shadow-none'"
              ></div>
          
            <div
            x-ref="lampRight"
            class="absolute -top-0 right-1/4 mt-35 w-20 md:w-35 h-3 rounded-full z-10 transition-all duration-700"
            :class= "open ? 'bg-blue-100 shadow-[0_0_6px_#ccfaff,0_0_12px_#ccfaff] animate-blink' : 'bg-gray-600 shadow-none'"
              ></div>
            <div class="flex flex-col p-15">
              {/* IZQUIERDA: contenido del .md */}
              <div class="text-white prose prose-invert max-w-none p-4 text-justify items-center justify-center">
                <Content />
                {url && typeof url === "string" && (
                  <>
                    <p class="text-center mt-10"><strong>Enlace a Github: </strong></p>
                    <a href={url} target="_blank" rel="noopener noreferrer" title="Ver repositorio en GitHub">
                      <Icon
                        name="github"
                        class="size-16 text-white hover:text-red-400 hover:cursor-pointer mx-auto my-4"
                      />
                    </a>
                  </>
                )}
              </div>

              {/* DERECHA: imagen + iconos */}
              <div class="flex flex-col items-center justify-start p-4 md:ml-10">
                {img && (
                  <img
                    src={`/images/${img}`}
                    alt={`Vista previa del proyecto ${name}`}
                    class="w-full h-auto rounded-lg shadow-lg mb-4"
                  />
                )}
                
                {prog_logos.length > 0 && (
                  <div class="flex flex-wrap justify-center items-center gap-4 mt-2 hover:cursor-pointer">
                    {prog_logos.map((logo) => (
                      <Icon
                        name={logo}
                        class="size-12 text-white hover:text-primary-light"
                        title={logo}
                      />
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    })
  } 
</section>
